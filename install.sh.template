#!/bin/bash
set -euo pipefail

# ============================================================================
# TEMPLATE USAGE
# ============================================================================
#
# This is a reusable installer template for Claude Code plugins.
#
# To use:
#   1. Replace {{project}} with your project name (lowercase)
#   2. Replace {{Project}} with your project name (capitalized)
#   3. Save as install.sh in your project root
#   4. Make executable: chmod +x install.sh
#
# Examples:
#   {{project}} -> code-zen, semantic-docstrings, my-plugin
#   {{Project}} -> Code-zen, Semantic-docstrings, My-plugin
#
# ============================================================================

# ============================================================================
# {{Project}} Installer
# Installs the {{Project}} architecture framework to ~/.claude/{{project}}
# ============================================================================

# --- Constants ---
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'

# --- Configuration ---
readonly REPO_URL="https://github.com/daviguides/{{project}}.git"
readonly TMP_DIR="/tmp/{{project}}-$$"
readonly CLAUDE_DIR="$HOME/.claude"
readonly TARGET_DIR="$CLAUDE_DIR/{{project}}"
readonly SOURCE_SUBDIR="{{project}}"

# --- Cleanup ---
cleanup() {
  if [ -d "$TMP_DIR" ]; then
    printf "%b\n" "${BLUE}Cleaning up temporary files...${NC}"
    rm -rf "$TMP_DIR"
  fi
}
trap cleanup EXIT

# ============================================================================
# Helper Functions
# ============================================================================

print_header() {
  printf "%b\n" "${BLUE}{{Project}} Installer${NC}"
  printf "%b\n\n" "${BLUE}===========================${NC}"
}

check_dependencies() {
  if ! command -v git >/dev/null 2>&1; then
    printf "%b\n" "${RED}Error: git is not installed${NC}"
    printf "%s\n" "Install: https://git-scm.com/downloads"
    exit 1
  fi
}

clone_repository() {
  printf "%b\n" "${BLUE}Cloning {{Project}} repository...${NC}"

  if ! git clone --quiet "$REPO_URL" "$TMP_DIR" 2>/dev/null; then
    printf "%b\n" "${RED}Error: Failed to clone repository${NC}"
    printf "Repository: %s\n" "$REPO_URL"
    exit 1
  fi

  printf "%b\n\n" "${GREEN}✓ Repository cloned successfully${NC}"
}

validate_source_structure() {
  local src_subdir="$TMP_DIR/$SOURCE_SUBDIR"

  if [ ! -d "$src_subdir" ]; then
    printf "%b\n" "${RED}Error: expected subfolder not found:${NC} $src_subdir"
    printf "%s\n" "Repository structure may have changed. Verify '{{project}}/' exists at repo root."
    exit 1
  fi
}

confirm_overwrite() {
  if [ -d "$TARGET_DIR" ]; then
    read -p "Directory $TARGET_DIR already exists. Overwrite? (y/n) " -n 1 -r
    printf "\n"

    if [[ $REPLY =~ ^[Yy]$ ]]; then
      rm -rf "$TARGET_DIR"
    else
      printf "%b\n" "${YELLOW}Installation cancelled.${NC}"
      exit 0
    fi
  fi
}

copy_files() {
  local src_subdir="$TMP_DIR/$SOURCE_SUBDIR"

  mkdir -p "$TARGET_DIR"

  if command -v rsync >/dev/null 2>&1; then
    # Prefer rsync for better control
    rsync -a "$src_subdir"/ "$TARGET_DIR"/
  else
    # POSIX fallback (includes dotfiles)
    ( set -f; cp -R "$src_subdir"/. "$TARGET_DIR"/ )
  fi
}

install() {
  printf "%b\n" "${BLUE}Installing {{project}} to $TARGET_DIR...${NC}"

  # Ensure ~/.claude directory exists
  [ -d "$CLAUDE_DIR" ] || mkdir -p "$CLAUDE_DIR"

  confirm_overwrite
  copy_files

  printf "%b\n\n" "${GREEN}✓ {{project}} installed successfully!${NC}"
}

print_next_steps() {
  printf "%b\n" "${GREEN}Installation complete!${NC}"
  printf "%b\n\n" "${BLUE}Next steps:${NC}"
  printf "%s\n" "1. Use /load-{{project}}-context command to load {{Project}} context when needed"
  printf "%s\n" "2. Or reference specific specs/context files in your prompts"
  printf "%s\n" "3. Docs: https://github.com/daviguides/{{project}}"
}

# ============================================================================
# Main
# ============================================================================

main() {
  print_header
  check_dependencies
  clone_repository
  validate_source_structure
  install
  print_next_steps
}

# Entry point
main
